<!DOCTYPE>
<html>

<head>
	<meta charset='utf-8' />
	<title>Ptolemy's Geography</title>
	<link rel="stylesheet" href="ol/ol.css">
	<link rel="stylesheet" href="stylesheet_webmaps.css">
	<!-- <link href="https://fonts.googleapis.com/css?family=Raleway|Roboto+Slab" rel="stylesheet"> -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">
	<script src="ol/ol.js"></script>
	<script src="jquery/jquery.min.js"></script>
</head>

<body>

	<!-- Create top panel with map information -->
	<div class="top-pad">
		<h1>La Géographie de Ptolémée - Les alignements maritimes</h1>
	</div>

	<!-- Create map container and tools -->
	<div id="map" class="map"></div>

	<div id="mouse-position"><p id="mouse-coordinates"></p></div>

	<table class="measure-tool">
		<tr>
			<td class="" id="ruler-div">
				<img class="" id="ruler" src="images/ruler.svg" alt="Ruler" title="Mesure de distance">
			</td>
			<td class="text-div">
				<label>Valeur du st/°Long</label>
			</td>
			<td class="input-div">
				<input id="st-value" type="text" name="st-value" value=400 size="4"/>
			</td>
		</tr>
	</table>

	<div id="information" class="">
		<p>?</p>
	</div>

	<div class="" id="snapping-tool">
		<img class="" id="snap" src="images/anchor.svg" alt="Snapping tool" title="Outil d'accrochage">
	</div>

	<div id="tooltip">
		<p>Cette carte interactive a été obtenue en manipulant la base de données constituée par Ptolémée pour sa Géographie.</p>
		<p>Seuls les sites littoraux contenus dans celle-ci ont été retenus. Ils ont été traités afin d'obtenir des alignements maritimes de trois points ou plus.</p>
		<hr />
		<p><b>Outils disponibles :</b></p>
		<p><img src="images/layers.svg" alt="Layers" title="Gestion des couches" align="left" style="width:15px;height:15px;">&nbsp;&nbsp;Gestion des couches</p>
		<p><img src="images/ruler.svg" alt="Ruler" title="Mesure de distance" align="left" style="width:15px;height:15px;">&nbsp;&nbsp;Mesure de distance en stades</p>
		<p><img src="images/anchor.svg" alt="Snapping tool" title="Outil d'accrochage" align="left" style="width:15px;height:15px;">&nbsp;&nbsp;Accrochage aux géométries</p>
	</div>

	<div id="layers-button" class="">
		<img src="images/layers.svg" alt="Layers" title="Gestion des couches" style="width:15px;height:15px;">
	</div>

	<div id="layers">
		<p>incertitude de position</p>
		<hr />
		<table class="layers-container">
			<col width="20px">
			<col width="140px">
			<col width="20px">
			<tr>
				<td class="layer-checkbox checked" id="alignements0" style="width:20px"></td>
				<td class="layer-text">Alignement ± 0'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements05" style="width:20px"></td>
				<td class="layer-text">Alignement ± 0.5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements1" style="width:20px"></td>
				<td class="layer-text">Alignement ± 1'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements15" style="width:20px"></td>
				<td class="layer-text">Alignement ± 1.5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements2" style="width:20px"></td>
				<td class="layer-text">Alignement ± 2'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements25" style="width:20px"></td>
				<td class="layer-text">Alignement ± 2.5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements3" style="width:20px"></td>
				<td class="layer-text">Alignement ± 3'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements35" style="width:20px"></td>
				<td class="layer-text">Alignement ± 3.5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements4" style="width:20px"></td>
				<td class="layer-text">Alignement ± 4'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements45" style="width:20px"></td>
				<td class="layer-text">Alignement ± 4.5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox" id="alignements5" style="width:20px"></td>
				<td class="layer-text">Alignement ± 5'</td>
			</tr>
			<tr>
				<td class="layer-checkbox checked" id="draw_layer" style="width:20px"></td>
				<td class="layer-text">Mesures (lignes)</td>
				<td class="clean-layer" style="width:20px">
					<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
						 width="15px" height="15px" viewBox="0 0 357 357" enable-background="new 0 0 357 357" xml:space="preserve">
							<g id="clear1">
								<polygon points="357,35.7 321.3,0 178.5,142.8 35.7,0 0,35.7 142.8,178.5 0,321.3 35.7,357 178.5,214.2 321.3,357 357,321.3     214.2,178.5   " fill="#FFFFFF"/>
							</g>
					</svg>
				</td>
			</tr>
			<tr>
				<td class="layer-checkbox checked" id="draw_tooltips" style="width:20px"></td>
				<td class="layer-text">Mesures (labels)</td>
				<td class="clean-layer" style="width:20px">
					<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
						 width="15px" height="15px" viewBox="0 0 357 357" enable-background="new 0 0 357 357" xml:space="preserve">
							<g id="clear2">
								<polygon points="357,35.7 321.3,0 178.5,142.8 35.7,0 0,35.7 142.8,178.5 0,321.3 35.7,357 178.5,214.2 321.3,357 357,321.3     214.2,178.5   " fill="#FFFFFF"/>
							</g>
					</svg>
				</td>
			</tr>
		</table>
	</div>

	<script type="text/javascript">
		// -----------------------------------
		// Create map layers and basic styling
		// -----------------------------------

		// Create Ecoumène layer
		var ec_style1 = new ol.style.Style({
			stroke: new ol.style.Stroke({
				color: 'rgba(155, 195, 225, 0.25)',
				width: 8
			}),
			zIndex: 1,
		});

		var ec_style2 = new ol.style.Style({
			stroke: new ol.style.Stroke({
				color: '#806e4b',
				width: 0.25
			}),
			fill: new ol.style.Fill({
				color: '#ffdc96'
			}),
			zIndex: 2,
		})

		var ecoumene = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Ecoumene.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'ecoumene',
			style: [ec_style1, ec_style2],
			zIndex: 3,
		});

		// Create graticule layer
		var graticule = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Graticule_500st1deg.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'graticule',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: [0,0,0,0.1],
					width: 0.5,
				})
			}),
			zIndex: 4,
		});

		// Create alignments layers
		var alignements0 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements0',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#00022b',
					width: 0.5,
				})
			}),
			zIndex: 14,
		});

		var alignements05 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0083.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements05',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#030a35',
					width: 0.5,
				})
			}),
			zIndex: 13,
		});

		var alignements1 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0167.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements1',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#07123e',
					width: 0.5,
				})
			}),
			zIndex: 12,
		});

		var alignements15 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-025.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements15',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#0b1b48',
					width: 0.5,
				})
			}),
			zIndex: 11,
		});

		var alignements2 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0333.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements2',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#0f2352',
					width: 0.5,
				})
			}),
			zIndex: 10,
		});

		var alignements25 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0417.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements25',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#132c5c',
					width: 0.5,
				})
			}),
			zIndex: 9,
		});

		var alignements3 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-05.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements3',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#19386a',
					width: 0.5,
				})
			}),
			zIndex: 8,
		});

		var alignements35 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0583.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements35',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#26528a',
					width: 0.5,
				})
			}),
			zIndex: 7,
		});

		var alignements4 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0667.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements4',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#2778ab',
					width: 0.5,
				})
			}),
			zIndex: 6,
		});

		var alignements45 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-075.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements45',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#6199b7',
					width: 0.5,
				})
			}),
			zIndex: 5,
		});

		var alignements5 = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Alignements_IC_0-0833.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				})
			}),
			title: 'alignements5',
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#74a6c2',
					width: 0.5,
				})
			}),
			zIndex: 5,
		});

		// Create sites layer
		var sites = new ol.layer.Vector({
			source: new ol.source.Vector({
				url: 'json/Points.geojson',
				format: new ol.format.GeoJSON({
					defaultDataProjection: 'EPSG:4326',
				}),
			}),
			style: function(feature, resolution) {
				var nom = map.getView().getZoom() > 5 ? feature.get('NOM') : '';
				nom = stringDivider(nom, 16, '\n');
				var BaseStyle = new ol.style.Style({
					text: new ol.style.Text({
						text: nom,
						font: '11px Roboto, serif',
						overflow: 'wrap',
						offsetY: -15,
						stroke: new ol.style.Stroke({
							color: [255, 255, 255, .5],
							width: 4,
						}),
					}),
					image: new ol.style.Circle({
						radius: 2.5,
						fill: new ol.style.Fill({
							color: '#fff'
						}),
						stroke: new ol.style.Stroke({
							color: '#333',
							width: 1,
						}),
					}),
				});
				return [BaseStyle];
			},
			zIndex: 15,
		});

		// Create layer for the length measuring tool
		var draw_source = new ol.source.Vector({
			wrapX: false,
		});
		var draw_vector = new ol.interaction.Draw({
			source: draw_source,
			type: 'LineString',
			// condition: function(e) {
			//   // Allow to draw only when left-click is pressed
			//   if (e.pointerEvent.buttons === 1) {
			//     return true;
			//   } else {
			//     return false;
			//   }
			// },
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#2e2e2e',
					width: 1,
					lineDash: [2, 2],
				}),
				image: new ol.style.Circle({
					radius: 5,
					stroke: new ol.style.Stroke({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 0.2)',
					}),
				}),
			}),
		});
		var draw_layer = new ol.layer.Vector({
			title: 'Mesure',
			source: draw_source,
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#2e2e2e',
					width: 1,
					lineDash: [2, 2],
				}),
			}),
			zIndex: 16,
		});

		// Create source and layer for the measure tooltip
		var tooltip_source = new ol.source.Vector({
			wrapX: false,
		});
		var draw_tooltips = new ol.layer.Vector({
			title: 'Tooltip',
			source: tooltip_source,
			type: 'overlay',
			style: function(feature, resolution) {
				var measure = map.getView().getZoom() > 5 ? feature.get('measure') : '';
				var MeasureStyle = new ol.style.Style({
					text: new ol.style.Text({
						text: measure,
						font: '10px Roboto, serif',
						placement: 'point',
						backgroundFill: new ol.style.Fill({
							color: 'rgba(255,255,255,.5)'
						}),
						padding: [5, 5, 5, 5],
						offsetY: 15,
						offsetX: -25,
					}),
				});
				return [MeasureStyle];
			},
			zIndex: 17,
		});

		// --------------------------------
		// Create map and add vector layers
		// --------------------------------

		// Create map
		var map = new ol.Map({
			// interactions: ol.interaction.defaults().extend([draw_vector]),
			layers: [ecoumene, graticule, alignements0, sites, draw_layer, draw_tooltips],
			target: 'map',
			view: new ol.View({
				projection: 'EPSG:4326',
				center: [30, 54],
				zoom: 5.75,
				minZoom: 3,
				maxZoom: 12,
			}),
			wrapX: false,
		});

		// ----------------
		// Advanced styling
		// ----------------


		// -------------
		// Miscellaneous
		// -------------

		// Check if input array contains input value
		function isInArray(value, array) {
		  return array.indexOf(value) > -1;
		}

		// Wrapper for strings used as labels
		function stringDivider(str, width, spaceReplacer) {
			if (str.length > width) {
				var p = width;
				while (p > 0 && (str[p] != ' ' && str[p] != '-')) {
					p--;
				}
				if (p > 0) {
					var left;
					if (str.substring(p, p + 1) == '-') {
						left = str.substring(0, p + 1);
					} else {
						left = str.substring(0, p);
					}
					var right = str.substring(p + 1);
					return left + spaceReplacer + stringDivider(right, width, spaceReplacer);
				}
			}
			return str;
		};

		// Measure button toggle
		var ruler_div = document.getElementById('ruler-div');
		ruler_div.onclick = function toggleMeasure() {
			// var ruler_div = document.getElementById('ruler-div');
			var tool_status = ruler_div.className;
			if (tool_status === "pushed") {
				ruler_div.style.backgroundColor = "#1E1E20";
				ruler_div.classList.remove("pushed");
				map.removeInteraction(draw_vector);
				snapping_div.style.backgroundColor = "#1E1E20";
				snapping_div.classList.remove("pushed");
				map.removeInteraction(snap_sites);
				map.removeInteraction(snap_drawings);
			} else {
				ruler_div.style.backgroundColor = "#374140";
				ruler_div.classList.add("pushed");
				map.addInteraction(draw_vector);
			}
		};

		// Snap button toggle
		var snap_sites = new ol.interaction.Snap({
			source: sites.getSource(),
		});
		var snap_drawings = new ol.interaction.Snap({
			source: draw_layer.getSource(),
		});
		var snapping_div = document.getElementById('snapping-tool');
		snapping_div.onclick = function toggleSnapping() {
			var tool_status = snapping_div.className;
			if (tool_status === "pushed") {
				snapping_div.style.backgroundColor = "#1E1E20";
				snapping_div.classList.remove("pushed");
				map.removeInteraction(snap_sites);
				map.removeInteraction(snap_drawings);
			} else {
				snapping_div.style.backgroundColor = "#374140";
				snapping_div.classList.add("pushed");
				map.addInteraction(snap_sites);
				map.addInteraction(snap_drawings);
			}
		};

		// Information button toggle
		$('#information').on('click', function() {
			$('#tooltip').toggle();
			var informationStatus = $('#information').attr('class');
			if (informationStatus == 'pushed') {
				$(this).removeClass('pushed');
				$(this).css("background-color", "#1E1E20")
			} else if (informationStatus != 'pushed') {
				$(this).addClass('pushed');
				$(this).css("background-color", "#374140");
			}
		});

		// Layers button toggle
		$('#layers-button').on('click', function() {
			$('#layers').toggle();
			var layersStatus = $('#layers').attr('class');
			if (layersStatus == 'pushed') {
				$(this).removeClass('pushed');
				$(this).css("background-color", "#1E1E20")
			} else if (layersStatus != 'pushed') {
				$(this).addClass('pushed');
				$(this).css("background-color", "#374140");
			}
		});

		// Add and remove layers
		$('.layer-checkbox').on('click', function() {
			var checkStatus = $(this).attr('class');
			var layerId = $(this).attr('id') ;
			if (isInArray("checked", checkStatus)) {
				$(this).removeClass('checked');
				map.removeLayer(eval(layerId));
			} else {
				$(this).addClass('checked');
				map.addLayer(eval(layerId));
			}
		});

		// Clear drawings
		var clear1 = document.getElementById('clear1');
		var clear2 = document.getElementById('clear2');
		clear1.onclick = function clearData1() {
			draw_source.clear();
		}
		clear2.onclick = function clearData2() {
			tooltip_source.clear();
		}

		// ----------------------
		// Create measure tooltip
		// ----------------------

		draw_vector.on('drawend', function(evt) {
			var feature = evt.feature; // Get line feature
			var l = feature.getGeometry(); // Get feature geometry
			var l_coords = l.getCoordinates() // Get coordinates of points in feature geometry
			var n_vertices = l.getCoordinates().length // Get number of points in the feature
			var st_long = parseInt(document.getElementById('st-value').value, 10);

			var length_st = 0;
			for (i = 0; i < n_vertices - 1; i++) {
				length_st += (((l_coords[i][0] - l_coords[i + 1][0]) * st_long) ** 2 + ((l_coords[i][1] - l_coords[i + 1][1]) * 500) ** 2) ** 0.5;
			}

			tooltip_source.addFeature(
				new ol.Feature({
					geometry: new ol.geom.Point([l_coords[n_vertices - 1][0], l_coords[n_vertices - 1][1]]),
					measure: Math.round(length_st).toString().concat(" st"),
				}),
			);
		});

		// ------------------
		// Add mouse position
		// ------------------

		map.addControl(new ol.control.MousePosition({
			coordinateFormat: function(coordinate) {
	      return ol.coordinate.format(coordinate, '<b>Position du curseur :</b> {y}°N, {x}°E', 3);
	    },
			projection: 'EPSG:4326',
			className: 'custom-mouse-position',
			target: document.getElementById('mouse-coordinates'),
			undefinedHTML: ''
		}));

	</script>
</body>

</html>
